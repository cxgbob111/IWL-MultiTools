"""inputs.py v6.0 â€“ ä¾§è¾¹æ è¾“å…¥æ§ä»¶ï¼ŒæŒ‰åŠŸèƒ½åŒºæŠ˜å æ˜¾ç¤ºã€‚"""

import streamlit as st
from utils.param_metadata import param_info, get_param_help


def sidebar_inputs() -> dict:
    """ç”Ÿæˆä¾§è¾¹æ è¾“å…¥æ§ä»¶å¹¶è¿”å›å‚æ•°å­—å…¸ã€‚"""
    params: dict = {}
    st.sidebar.markdown("**ç‰ˆæœ¬å·ï¼šV6.0 - 2025-08-05**")
    # èˆ¹å‹å¼€å…³ä¸è¡¥è´´
    with st.sidebar.expander("âš™ï¸ èˆ¹å‹å¼€å…³ä¸è¡¥è´´è®¾ç½®", expanded=False):
        params['show_stage_v'] = st.checkbox("STAGE V æŸ´æ²¹èˆ¹ (EU)", True, key="show_stage_v"); params['show_electric_eu'] = st.checkbox("ç”µåŠ¨èˆ¹ (EU)", True, key="show_electric_eu"); params['show_electric_cn'] = st.checkbox("ç”µåŠ¨èˆ¹ (CN)", True, key="show_electric_cn"); params['subsidy_ratio_stage_v'] = st.slider("STAGE V è¡¥è´´æ¯”ä¾‹ (%)", 0.0, 0.5, 0.2, 0.01, key="subsidy_ratio_stage_v"); params['subsidy_ratio_electric_eu'] = st.slider("ç”µåŠ¨èˆ¹(EU)è¡¥è´´æ¯”ä¾‹ (%)", 0.0, 0.5, 0.3, 0.01, key="subsidy_ratio_electric_eu"); params['subsidy_ratio_electric_cn'] = st.slider("ç”µåŠ¨èˆ¹(CN)è¡¥è´´æ¯”ä¾‹ (%)", 0.0, 0.5, 0.3, 0.01, key="subsidy_ratio_electric_cn")
    # èˆ¹èˆ¶ä¸ç‰©æµå‚æ•°
    with st.sidebar.expander("ğŸš¢ èˆ¹èˆ¶ä¸ç‰©æµå‚æ•°", expanded=False):
        fields=[('ship_length','èˆ¹é•¿ (m)',30.0,135.0,1.0),('carry_per_meter','æ¯ç±³èˆ¹é•¿å¹³å‡è½½è´§é‡ (å¨/m)',5.0,20.0,0.5),('avg_trip_distance','å¹³å‡å•ç¨‹èˆªè· (km)',10.0,300.0,1.0),('economic_speed','ç»æµèˆªé€Ÿ (km/h)',5.0,25.0,0.1),('turnaround_time','è£…å¸åŠç­‰å€™æ—¶é—´ (h)',0.0,24.0,0.5),('annual_hours','å¹´åº¦è¿è¥å°æ—¶æ•°',0.0,8760.0,100.0),('crew_num','èˆ¹å‘˜æ•°',1.0,100.0,1.0),('crew_avg_cost','å•åèˆ¹å‘˜å¹´å¹³å‡æˆæœ¬ (â‚¬)',0.0,200000.0,1000.0)]
        for k,l,min_v,max_v,step in fields:
            params[k]=st.number_input(l, value=float(param_info.get(k, {}).get('default', 0.0)), min_value=min_v, max_value=max_v, step=step, key=k, help=get_param_help(k))
    # èƒ½æºå‚æ•°
    with st.sidebar.expander("âš¡ èƒ½æºå‚æ•°", expanded=False):
        params['mgo_price']=st.slider("æŸ´æ²¹ä»·æ ¼ (â‚¬/L)", 0.3, 2.0, float(param_info['mgo_price']['default']), 0.01, key='mgo_price', help=get_param_help('mgo_price')); params['electricity_price']=st.slider("ç”µä»· (â‚¬/kWh)", 0.1, 0.5, float(param_info['electricity_price']['default']), 0.01, key='electricity_price', help=get_param_help('electricity_price')); params['diesel_consumption_per_hour']=st.number_input("æŸ´æ²¹è€—èƒ½ (L/h)", value=float(param_info['diesel_consumption_per_hour']['default']), min_value=50.0, max_value=200.0, step=1.0, key='diesel_consumption_per_hour', help=get_param_help('diesel_consumption_per_hour')); params['electric_consumption_per_hour']=st.number_input("ç”µåŠ¨è€—èƒ½ (kWh/h)", value=float(param_info['electric_consumption_per_hour']['default']), min_value=100.0, max_value=500.0, step=1.0, key='electric_consumption_per_hour', help=get_param_help('electric_consumption_per_hour')); hrs=params.get('annual_hours', param_info['annual_hours']['default'])/365.0; daily_diesel=params['diesel_consumption_per_hour']*hrs*params['mgo_price']; daily_electric=params['electric_consumption_per_hour']*hrs*params['electricity_price']; st.metric("æŸ´æ²¹èˆ¹æ—¥èƒ½æºæˆæœ¬ (â‚¬)", f"{daily_diesel:,.2f}"); st.metric("ç”µåŠ¨èˆ¹æ—¥èƒ½æºæˆæœ¬ (â‚¬)", f"{daily_electric:,.2f}")
    # ç”µæ± å‚æ•°
    with st.sidebar.expander("ğŸ”‹ ç”µæ± å‚æ•°", expanded=False):
        params['battery_price']=st.slider("ç”µæ± å•ä»· (â‚¬/kWh)", 200.0, 800.0, float(param_info['battery_price']['default']), 10.0, key='battery_price', help=get_param_help('battery_price')); params['battery_capacity_kWh']=st.number_input("ç”µæ± å®¹é‡ (kWh)", value=float(param_info['battery_capacity_kWh']['default']), min_value=500.0, max_value=10000.0, step=10.0, key='battery_capacity_kWh', help=get_param_help('battery_capacity_kWh')); params['battery_cycle_life']=st.number_input("ç”µæ± æ·±åº¦å¾ªç¯æ¬¡æ•°", value=float(param_info['battery_cycle_life']['default']), min_value=1000.0, max_value=10000.0, step=100.0, key='battery_cycle_life', help=get_param_help('battery_cycle_life')); params['battery_replace_ratio_eu']=st.slider("EUç”µæ± æ›´æ¢æˆæœ¬æ¯”ç‡", 0.1, 1.0, float(param_info['battery_replace_ratio_eu']['default']), 0.05, key='battery_replace_ratio_eu', help=get_param_help('battery_replace_ratio_eu')); params['battery_replace_ratio_cn']=st.slider("CNç”µæ± æ›´æ¢æˆæœ¬æ¯”ç‡", 0.1, 1.0, float(param_info['battery_replace_ratio_cn']['default']), 0.05, key='battery_replace_ratio_cn', help=get_param_help('battery_replace_ratio_cn')); params['battery_replace_cost_eu']=params['battery_capacity_kWh']*params['battery_price']*params['battery_replace_ratio_eu']; params['battery_replace_cost_cn']=params['battery_capacity_kWh']*params['battery_price']*0.7*params['battery_replace_ratio_cn']; st.metric("EUç”µåŠ¨èˆ¹å•æ¬¡æ¢ç”µæˆæœ¬ (â‚¬)", f"{params['battery_replace_cost_eu']:,.0f}"); st.metric("CNç”µåŠ¨èˆ¹å•æ¬¡æ¢ç”µæˆæœ¬ (â‚¬)", f"{params['battery_replace_cost_cn']:,.0f}")
    # è¿ç»´ä¸å‘¨æœŸè´¹ç”¨
    with st.sidebar.expander("ğŸ›  è¿ç»´ä¸å‘¨æœŸè´¹ç”¨", expanded=False):
        params['maintenance_cost_diesel']=st.number_input("æŸ´æ²¹èˆ¹ç»´æŠ¤ (â‚¬/å¹´)", value=float(param_info['maintenance_cost_diesel']['default']), min_value=0.0, max_value=1e6, step=1000.0, key='maintenance_cost_diesel', help=get_param_help('maintenance_cost_diesel')); params['maintenance_cost_electric']=st.number_input("ç”µåŠ¨èˆ¹ç»´æŠ¤ (â‚¬/å¹´)", value=float(param_info['maintenance_cost_electric']['default']), min_value=0.0, max_value=1e6, step=1000.0, key='maintenance_cost_electric', help=get_param_help('maintenance_cost_electric')); params['port_fee']=st.number_input("æ¸¯å£è´¹ (ä»…æŸ´æ²¹èˆ¹, â‚¬/å¹´)", value=float(param_info['port_fee']['default']), min_value=0.0, max_value=1e6, step=1000.0, key='port_fee', help=get_param_help('port_fee')); params['overhaul_interval_years_diesel']=st.number_input("æŸ´æ²¹èˆ¹å¤§ä¿®å‘¨æœŸ (å¹´)", value=float(param_info['overhaul_interval_years_diesel']['default']), min_value=1.0, max_value=25.0, step=1.0, key='overhaul_interval_years_diesel', help=get_param_help('overhaul_interval_years_diesel')); params['overhaul_cost_per_event_diesel']=st.number_input("æŸ´æ²¹èˆ¹å•æ¬¡å¤§ä¿®æˆæœ¬ (â‚¬)", value=float(param_info['overhaul_cost_per_event_diesel']['default']), min_value=0.0, max_value=1e6, step=1000.0, key='overhaul_cost_per_event_diesel', help=get_param_help('overhaul_cost_per_event_diesel'))
    # æ”¶ç›Šä¸ä¿é™©è®¾ç½®
    with st.sidebar.expander("ğŸ’° æ”¶ç›Šä¸ä¿é™©è®¾ç½®", expanded=False):
        params['unit_income']=st.number_input("å•ä½è¿è´¹/æ”¶ç›Š (â‚¬/å¨Â·å…¬é‡Œ)", value=float(param_info['unit_income']['default']), min_value=0.0, max_value=1.0, step=0.001, key='unit_income', help=get_param_help('unit_income')); params['annual_income']=st.number_input("æ‰‹åŠ¨å¹´æ”¶å…¥ (â‚¬/å¹´)", value=0.0, min_value=0.0, max_value=1e9, step=1000.0, key='annual_income', help="å¯æ‰‹åŠ¨è¾“å…¥å¹´æ”¶å…¥ï¼Œç•™ç©ºæˆ–0åˆ™è‡ªåŠ¨ä¼°ç®—ã€‚"); params['insurance_rate']=st.number_input("åŸºç¡€ä¿é™©è´¹ç‡ (%)", value=5.0, min_value=0.0, max_value=20.0, step=0.1, key='insurance_rate', help="ä¸€èˆ¬ä¿é™©è´¹ç‡ 1%~5%ã€‚"); params['insurance_discount']=st.number_input("æ™ºèƒ½åŒ–è®¾å¤‡ä¿é™©ä¼˜æƒ  (%)", value=float(param_info.get('insurance_discount',{}).get('default',0.0)), min_value=0.0, max_value=100.0, step=0.1, key='insurance_discount', help=get_param_help('insurance_discount')); params['smart_equipment_selected']=st.checkbox("å¢åŠ æ™ºèƒ½åŒ–è®¾å¤‡ (ä»…ç”µåŠ¨èˆ¹)", value=False, key='smart_equipment_selected', help="é€‰ä¸­åç”µåŠ¨èˆ¹ä¿é™©è´¹æŒ‰æŠ˜æ‰£è®¡ç®—")
    # åˆæœŸå»ºé€ æˆæœ¬
    with st.sidebar.expander("ğŸš§ åˆæœŸå»ºé€ æˆæœ¬ (å•ä½ï¼š10k â‚¬)", expanded=False):
        comps=["èˆ¹ä½“","æ¨è¿›ç³»ç»Ÿ","ç”µæ°”è‡ªåŠ¨åŒ–","å±…ä½åŒº","èˆ¾è£…è®¾å¤‡","ç»„è£…è°ƒè¯•"]; defaults={'æŸ´æ²¹èˆ¹':[60.0,25.0,20.0,10.0,8.0,5.0],'ç”µåŠ¨èˆ¹(EU)':[60.0,20.0,25.0,10.0,8.0,5.0],'ç”µåŠ¨èˆ¹(CN)':[40.0,15.0,15.0,7.0,6.0,3.5]}
        for ship,vals in defaults.items(): params[ship]=[st.number_input(f"{ship}{c} (10kâ‚¬)", value=v, min_value=0.0, max_value=100.0, step=0.1, key=f"{ship}_{c}", help=get_param_help(f"{ship}_{c}")) for c,v in zip(comps,vals)]
        raw_d=sum(params['æŸ´æ²¹èˆ¹'])*1e4; raw_eu=sum(params['ç”µåŠ¨èˆ¹(EU)'])*1e4+params['battery_capacity_kWh']*params['battery_price']; raw_cn=sum(params['ç”µåŠ¨èˆ¹(CN)'])*1e4+params['battery_capacity_kWh']*params['battery_price']*0.7; st.metric("STAGE V æŸ´æ²¹èˆ¹åŸå§‹å»ºé€ æˆæœ¬ (â‚¬)",f"{raw_d:,.0f}"); st.metric("ç”µåŠ¨èˆ¹(EU)åŸå§‹å»ºé€ æˆæœ¬ (â‚¬)",f"{raw_eu:,.0f}"); st.metric("ç”µåŠ¨èˆ¹(CN)åŸå§‹å»ºé€ æˆæœ¬ (â‚¬)",f"{raw_cn:,.0f}")
    return params